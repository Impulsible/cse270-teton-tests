name: CI Pipeline with Smoke Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install pytest selenium
        
    - name: Install Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
    - name: Install ChromeDriver
      run: |
        sudo apt-get install -y unzip
        CHROME_VERSION=$(google-chrome --version | awk '{print $3}')
        echo "Chrome version: $CHROME_VERSION"
        # Use Chrome for Testing
        wget -q https://storage.googleapis.com/chrome-for-testing-public/latest/linux64/chromedriver-linux64.zip
        unzip chromedriver-linux64.zip
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
        chmod +x /usr/local/bin/chromedriver
        
    - name: Verify installations
      run: |
        google-chrome --version
        chromedriver --version
        
    - name: Start HTTP Server
      run: |
        python -m http.server 5500 &
        sleep 5
        
    - name: Test server connection
      run: |
        curl -I http://localhost:5500/cse270/teton/1.6/
        wget -qO- http://localhost:5500/cse270/teton/1.6/ | head -20
        
    - name: Run tests
      run: |
        python -m pytest tests/test_smokeTest.py -v -s